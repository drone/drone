image: bradrydzewski/go:1.4
git:
  path: github.com/drone/drone
env:
  - GOROOT=/usr/local/go
  - PATH=$PATH:$GOROOT/bin:$GOPATH/bin
script:
  - sudo add-apt-repository ppa:git-core/ppa 1> /dev/null 2> /dev/null
  - sudo apt-get update 1> /dev/null 2> /dev/null
  - sudo apt-get -y install git zip libsqlite3-dev sqlite3 rpm dpkg 1> /dev/null 2> /dev/null
  - gem install fpm
  - rbenv rehash
  - make deps
  - make test
  - make test_postgres
  #- make test_mysql
  - make packages
services:
  - postgres
publish:
  docker:
    docker_host: $$docker_host
    email: $$docker_email
    username: $$docker_username
    password: $$docker_password
    image_name: clever/drone
    registry_login: true
    tags:
      - $(git rev-parse --short HEAD)
      #- latest
    when:
      branch: master
