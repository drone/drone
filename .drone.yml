clone:
  path: github.com/drone/drone

build:
  image: golang:1.5
  environment:
    - GO15VENDOREXPERIMENT=1
  commands:
    - /bin/bash contrib/setup-sqlite.sh 1> /dev/null
    - /bin/bash contrib/setup-sassc.sh  1> /dev/null
    - make deps gen test
    - make build build_static deb docs

publish:
  s3:
    acl: public-read
    region: us-east-1
    bucket: downloads.drone.io
    access_key: $$AWS_KEY
    secret_key: $$AWS_SECRET
    source: contrib/debian/drone.deb
    target: $$BRANCH/
    when:
      repo: drone/drone

  # sync the documentation with the s3 bucket

  s3_sync:
    acl: public-read
    region: us-east-1
    bucket: readme.drone.io
    access_key: $$AWS_KEY
    secret_key: $$AWS_SECRET
    source: /drone/tmp/
    target: /
    exclude: "*.svg"
    when:
      repo: drone/drone
      branch: "0.4.0"

  s3_sync:
    acl: public-read
    region: us-east-1
    bucket: readme.drone.io
    access_key: $$AWS_KEY
    secret_key: $$AWS_SECRET
    source: /drone/tmp/
    target: /
    exclude: "*"
    include: "**.svg"
    content_type: "image/svg+xml"
    when:
      repo: drone/drone
      branch: "0.4.0"

  docker:
    username: drone
    password: $$DOCKER_PASS
    email: $$DOCKER_EMAIL
    repo: drone/drone
    tag: "0.4"
    when:
      repo: drone/drone
      branch: 0.4.0
