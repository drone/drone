<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="drone-repo.html">
<link rel="import" href="drone-repo-list.html">

<dom-module id="drone-app">
	<template>
		<app-location
			route="{{route}}"
			url-space-regex="^(?!/login|/logout)">
		</app-location>

		<app-route
			route=[[route]]
			pattern="/:page"
			data={{data}}>
		</app-route>

		<app-route
			route=[[route]]
			data={{repo}}
			pattern="/:owner/:name"
			tail={{tail}}>
		</app-route>

		<iron-pages role="main"
			selected="[[data.page]]"
			fallback-selection="repo"
			attr-for-selected="page"
			selected-attribute="active">

			<drone-repo-list
				page="settings"
				user="[[user]]">
			</drone-repo-list>

			<drone-repo
				page="repo"
				route="[[tail]]"
				owner="[[repo.owner]]"
				name="[[repo.name]]"
				user="[[user]]">
			</drone-repo>

			<div name="welcome">
				<div>Welcome to Drone</div>
			</div>
		</iron-pages>

	</template>
	<script>
		Polymer({
			is: "drone-app",
			properties: {
				user: Object
			},
			ready: function() {
				this.user = window &&
					window.STATE_FROM_SERVER &&
					window.STATE_FROM_SERVER.user ?
					window.STATE_FROM_SERVER.user: null;
			},
			attached: function() {

				////////////////////////////////////////////////////////////////////////////
		    // TESTING ONLY. REMOVE
		    // var number = 541;
				// var i = 0;
		    // setInterval(function() {
				// 	if (i % 2 == 0) {
				// 		number++;
				// 	}
				// 	var data = {
		    //     repo: {
		    //       owner: "drone",
		    //       name: "drone",
		    //       full_name: "drone/drone"
		    //     },
		    //     build: {
		    //       number: number,
		    //       started_at: Math.round(new Date().getTime()/1000),
		    //       finished_at: Math.round(new Date().getTime()/1000)+180,
		    //       status: (i % 2 == 0)? "running": "failure",
				// 			event: "push",
				// 			ref: "refs/heads/master",
				// 			branch: "master",
				// 			author: "bradrydzewski",
				// 			author_avatar: "https://avatars.githubusercontent.com/u/541832?v=3",
		    //     }
		    //   };
			  //   i++;
		    //   this.fire("iron-signal", {name: "event", data: data});
		    // }.bind(this), 1000*5);
		    ////////////////////////////////////////////////////////////////////////////



				this.ws = this.createWebSocket();
				this.ws.onmessage = function (event) {
					var data = JSON.parse(event.data);
					this.fire("iron-signal", {name: "event", data: data});
				}.bind(this);
			},
			detached: function() {
				this.ws.close();
			},
			createWebSocket() {
				var proto = (window.location.protocol === 'https:') ? 'wss:' : 'ws:';
				return new WebSocket(proto + '//' + window.location.host + '/ws/feed');
		  }
		});
	</script>
</dom-module>
