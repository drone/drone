
<script src="../bower_components/ansi_up/ansi_up.js"></script>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="drone-api.html">
<link rel="import" href="drone-job.html">
<link rel="import" href="drone-job-list.html">
<link rel="import" href="drone-build-card.html">
<link rel="import" href="drone-error.html">

<dom-module id="drone-build">
	<template>
		<style>
			:host paper-progress {
				width: 100%;
				position: absolute;
				top: -40px;
				right: 0px;
				left: 0px;

				--paper-progress-active-color: #00BFA5
				--paper-progress-container-color: #EEEEEE;
			}
			:host details div {
				margin: 0px;
				background: #EEEEEE;
				color: #212121;
				font-size: 12px;
				line-height: 19px;
				white-space: pre-wrap;
				word-wrap: break-word;
				font-family: "Roboto Mono", monospace;
				padding:0px 20px;
			}
			:host details div:nth-child(2) {
				padding-top:20px;
				border-top-right-radius: 2px;
				border-top-left-radius: 2px;
			}
			:host details div:last-child {
				padding-bottom:20px;
				border-bottom-right-radius: 2px;
				border-bottom-left-radius: 2px;
			}
			:host details div a {
				color: #6fc2ef;
			}
			:host details {
				color: #212121;
				display: block;
			}
			:host summary {
				display:block;
				cursor: pointer;
				-webkit-user-select: none;
				font-weight: normal;
				display: block;
				outline: none;
				font-size: 15px;
				text-transform: lowercase;
				padding: 15px 5px;
				border-bottom: 1px solid #EEE;
			}
			:host details[open] summary {
				border-bottom: none;
			}
			:host details summary::-webkit-details-marker { display:none; }

			/** Term Colors from
				https://github.com/chriskempson/base16-shell/blob/master/base16-chalk.dark.sh */

			/** Term Foreground Colors */

			.ansi-black-fg { color: #151515; }
			.ansi-red-fg { color: #fb9fb1; }
			.ansi-green-fg { color: #acc267; }
			.ansi-yellow-fg { color: #ddb26f;}
			.ansi-blue-fg { color: #6fc2ef; }
			.ansi-magenta-fg { color: #e1a3ee;}
			.ansi-cyan-fg { color: #12cfc0; }
			.ansi-white-fg { color: #d0d0d0; }

			.ansi-bright-black-fg { color: #505050; }
			.ansi-bright-red-fg { color: #fb9fb1; }
			.ansi-bright-green-fg {color: #acc267;}
			.ansi-bright-yellow-fg {color: #ddb26f;}
			.ansi-bright-blue-fg {color: #6fc2ef;}
			.ansi-bright-magenta-fg {color: #e1a3ee;}
			.ansi-bright-cyan-fg {color: #12cfc0; }
			.ansi-bright-white-fg { color: #f5f5f5; }

			/** Term Background Colors */

			.ansi-black-bg { background-color: #151515; }
			.ansi-red-bg { background-color: #fb9fb1; }
			.ansi-green-bg { background-color: #acc267; }
			.ansi-yellow-bg { background-color: #ddb26f;}
			.ansi-blue-bg { background-color: #6fc2ef; }
			.ansi-magenta-bg { background-color: #e1a3ee;}
			.ansi-cyan-bg { background-color: #12cfc0; }
			.ansi-white-bg { background-color: #d0d0d0; }

			.ansi-bright-black-bg { background-color: #505050; }
			.ansi-bright-red-bg { background-color: #fb9fb1; }
			.ansi-bright-green-bg {background-color: #acc267;}
			.ansi-bright-yellow-bg {background-color: #ddb26f;}
			.ansi-bright-blue-bg {background-color: #6fc2ef;}
			.ansi-bright-magenta-bg {background-color: #e1a3ee;}
			.ansi-bright-cyan-bg {background-color: #12cfc0; }
			.ansi-bright-white-bg { background-color: #f5f5f5; }
		</style>

		<app-route
			route="[[route]]"
			pattern="/:build"
			data={{data}}
			tail={{subroute}}>
		</app-route>

		<app-route
			route="{{subroute}}"
			pattern="/:job"
			data={{subdata}}>
		</app-route>

		<drone-api id="drone"></drone-api>

		<iron-signals
			on-iron-signal-event="handleEvent"></iron-signals>

		<template is="dom-if" if="[[loading]]">
			<paper-progress indeterminate></paper-progress>
		</template>

		<template is="dom-if" if="{{error}}">
			<drone-error error="[[error]]"></drone-error>
		</template>

		<template is="dom-if" if="[[loading]]">
			<paper-progress indeterminate></paper-progress>
		</template>

		<template is="dom-if" if="[[showJobList(build, job)]]">
			<drone-job-list active=[[active]] repo=[[repo]] build=[[build]]></drone-job-list>
		</template>

		<template is="dom-if" if="[[showJob(build, job)]]">
			<drone-job active=[[active]] repo=[[repo]] build=[[build]] job=[[job]]></drone-job>
		</template>

		<!-- <div>
			<drone-build-card build="[[ build ]]"></drone-build-card>
			<div id="logs"></div>
		</div> -->


	</template>

	<script>
		Polymer({
			is: "drone-build",
			properties: {
				active: {
					type: Boolean,
					value: false
				},
				route: {
					type: Object
				},
				loading: {
					type: Boolean,
					value: true,
				},
				error: {
					type: Object,
					value: null
				},
				repo: {
					type: Object,
				},
				build: {
					type: Object
				},
				job: {
					type: Object
				}
			},
			observers: [
				"load(route, repo, data, subdata, active)",
			],
			load(route, repo, data, subdata, active) {

				// HACK this debounce is required because each of the above parameters
				// trigger a refresh. This means a single route change will cause
				// this to execute 4x each with a different parameter permutation.
				this.debounce("repo", function () {
					if (!active || !repo) return;
					// HACK this is a nasty hack because the subdata is not updated to
					// reflect the fact that the parent route no longer matches.
					var job = route.path.split("/").length==2?undefined:subdata.job;
					this.fetchBuild(repo, data.build, job);
				}.bind(this), 20);
			},
			showJob: function(build, job) {
				return !!job;
			},
			showJobList: function(build, job) {
				return !!!job;
			},
			fetchBuild: function(repo, number, job) {
				this.set("loading", true);
				this.$.drone.getBuild(repo, number).then(function(build) {
					this.set("build", build);
					this.set("error", null);
					this.set("loading", false);

					job = build.jobs.length == 1 ? 1: job;
					if (job) {
						this.set("job", build.jobs[job-1]);
					} else {
						this.set("job", null);
						this.set("job", undefined);
					}

				}.bind(this)).catch(function(error) {
					this.set("error", error);
				}.bind(this));
			},
			handleEvent: function(e) {
				var event = e.detail;

				if (!this.repo || !this.build) return;
				if (this.repo.full_name != event.repo.full_name) return;
				if (this.build.number != event.build.number) return;
				this.set("build.number", event.build.number);
				this.set("build.started_at", event.build.started_at);
				this.set("build.finished_at", event.build.finished_at);
				this.set("build.status", event.build.status);

				// if job status is running, reset all jobs to running

				if (!this.job || !event.job.number) return;
				if (!this.job.number != event.job.number) return;
				this.set("job", event.job);

				// if job is selected, and running, trigger log streaming
			}
		});
	</script>
</dom-module>
