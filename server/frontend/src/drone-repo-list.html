
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/page-title/page-title.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="drone-api.html">
<link rel="import" href="drone-repo-list-item.html">
<link rel="import" href="drone-shell.html">
<link rel="import" href="drone-toolbar.html">

<dom-module id="drone-repo-list">
	<template>
		<style>
			:host [drone-aside] > div {
				margin-bottom:15px;
				border-bottom:1px solid #EEE;
				padding:20px 0px;
			}

			:host .organization-item {
				display:flex;
				padding: 10px 0px;
				cursor: pointer;
				user-select: none;
				padding-left:30px;

				-webkit-display: flex;
				-webkit-user-select: none;
			}

			:host .organization-item.iron-selected {
				background: #EEE;
			}

			:host paper-button {
				margin: 0px;
				display: block;
				font-size: 14px;
				text-align: left;
				text-transform: uppercase;
				justify-content: flex-start;
				padding: 5px 30px;
				border-radius: 0px;
				margin-bottom: 5px;
				outline: none;
				cursor: pointer;
				--paper-button-ink-color: #BDBDBD;

				-webkit-outline: none;
			}

			:host paper-button iron-icon {
				padding:0px;
				margin-right:10px;
				color: #212121;

				--iron-icon-height: 20px;
				--iron-icon-width: 20px;
			}

			:host paper-button:last-child {
				margin-bottom:0px;
			}

			paper-dialog pre {
				border-radius:2px;
				background: #EEEEEE;
				color: #212121;
				font-size: 12px;
				line-height: 19px;
				white-space: pre-wrap;
				word-wrap: break-word;
				font-family: "Roboto Mono", monospace;
				max-width:500px;
				font-size: 15px;
				margin: 0px !important;
				padding: 30px !important;
			}

			:host paper-toast {
				bottom:40px;
				right:40px;
				left: auto !important;
				top: auto !important;
			}

			:host paper-progress {
				width: 100%;
				position: fixed;
				top: 0px;
				right: 0px;
				left: 0px;

				--paper-progress-active-color: #00BFA5
				--paper-progress-container-color: #EEEEEE;
			}
		</style>

		<template is="dom-if" if="[[active]]">
			<page-title base-title="drone" title="settings"></page-title>

			<template is="dom-if" if="[[loading]]">
				<paper-progress indeterminate></paper-progress>
			</template>
		</template>

		<drone-api id="drone"></drone-api>

		<drone-shell>
			<div drone-aside>
				<div>
					<paper-button tabindex="-1" id="tokenButton" on-click="displayToken">
						<iron-icon icon="visibility"></iron-icon> Show Token
					</paper-button>
					<paper-button tabindex="-1" id="refreshButton" on-click="refreshRepos">
						<iron-icon icon="cached"></iron-icon> Sync Account
					</paper-button>
				</div>
				<iron-selector selected="0" attr-for-selected="name" on-iron-select="itemSelected">
					<template is="dom-repeat" items="{{ computeOrgs(repos) }}" sort="sortOrgs">
						<div class="organization-item" name="[[ item.login ]]">[[ item.login ]]</div>
					</template>
				</iron-selector>
			</div>

			<div drone-header>
				<drone-toolbar page="Settings" user="[[user]]"></drone-toolbar>
			</div>

			<div drone-main>
				<template is="dom-repeat" items="[[repos]]" filter="[[computeFilter(selected)]]" sort="sortRepos">
					<drone-repo-list-item
						repo="{{item}}"
						on-toggle="handleToggle">
					</drone-repo-list-item>
				</template>
			</div>
		</drone-shell>

		<paper-dialog id="dialog" with-backdrop>
			<p>This is your personal API token:</p>
			<pre>[[ token ]]</pre>
		</paper-dialog>

		<paper-toast id="toast" text=""></paper-toast>
	</template>

	<script>
		Polymer({
			is: "drone-repo-list",
			properties: {
				active: {
					type: Boolean,
					value: false,
					observer: "refresh",
				},
				loading: {
					type: Boolean,
					value: true
				},
				user: {
					type: Object
				},
				token: {
					type: String
				}
			},
			refresh: function(active) {
				if (!active) return;
				this.$.drone.getRepoList({all: true}).then(function(repos) {
					this.set("repos", repos);
					this.set("loading", false);
				}.bind(this));
			},
			refreshRepos: function() {
				this.$.refreshButton.disabled=true;
				this.set("loading", true);
				this.$.drone.getRepoList({flush: true, all: true}).then(function(repos) {
					this.set("repos", repos);
					this.set("loading", false);
					this.$.refreshButton.disabled=false;
					this.$.toast.show("Successfully refreshed your repository list.")
				}.bind(this));
			},
			handleToggle: function(e) {
				if (!!e.detail.repo.id) {
					this.disableRepo(e.detail.repo);
				} else {
					this.enableRepo(e.detail.repo);
				}
			},
			enableRepo: function(repo) {
				this.$.drone.activateRepo(repo.owner, repo.name).then(function(resp) {
					repo.id = resp.id;
					this.$.toast.show("Successfully activated "+repo.name);
				}.bind(this)).catch(function() {
					console.error(err);
					this.$.toast.show("Unable to activate "+repo.name);
				}.bind(this));
			},
			disableRepo: function(repo) {
				this.$.drone.deleteRepo(repo.owner, repo.name).then(function() {
					delete repo.id;
					this.$.toast.show("Successfully deactivated "+repo.name);
				}.bind(this)).catch(function(err) {
					console.error(err);
					this.$.toast.show("Unable to deactivate "+repo.name);
				}.bind(this));
			},
			displayToken: function() {
				this.$.drone.getToken().then(function(token) {
					this.set("token", token);
					this.$.dialog.open();
					this.$.dialog.center();
				}.bind(this))
			},
			computeFilter: function(string) {
				if (!string) {
					return null;
				}
				return function(repo) {
					return repo.owner === string;
				};
			},
			computeOrgs: function(repos) {
				if (!repos) {
					return;
				}

				var index = {};
				var orgs = [];
				repos.map(function(repo) {
					if (index[repo.owner]) {
						return;
					}
					index[repo.owner] = repo.owner;
					orgs.push({
						login: repo.owner,
						avatar: repo.avatar_url
					});
				});
				return orgs;
			},
			sortOrgs: function(a, b) {
				if (a.login < b.login) return -1;
				if (a.login > b.login) return 1;
				return 0;
			},
			sortRepos: function(a, b) {
				if (a.full_name < b.full_name) return -1;
				if (a.full_name > b.full_name) return 1;
				return 0;
			},
			itemSelected: function(e) {
				this.selected = e.detail.item.name;
			}
		});
	</script>
</dom-module>
